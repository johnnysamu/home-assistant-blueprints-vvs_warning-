blueprint:
  name: Varning f√∂r VVS
  description: >-
    Varnar varje timme via h√∂gtalare och mobilnotis om vatten uppt√§cks samt
    skickar notis om sensorn inte kan n√•s.
  domain: automation
  input:
    sensor:
      name: Vattenl√§ckagesensor
      description: V√§lj vattenl√§ckagesensorn som ska √∂vervakas.
      selector:
        entity:
          domain: binary_sensor
          device_class: moisture
    media_player:
      name: H√∂gtalare
      description: V√§lj h√∂gtalaren som ska anv√§ndas f√∂r varningen.
      selector:
        entity:
          domain: media_player
    notify_device:
      name: Notisenhet
      description: V√§lj enheten som ska ta emot mobilnotiser.
      selector:
        device:
    repeat_count:
      name: Upprepningsantal
      description: Antal g√•nger varningarna ska upprepas.
      default: 5
      selector:
        number:
          min: 1
          max: 10
          unit_of_measurement: g√•nger
    media_content_id:
      name: Media Content ID
      description: URL till mediefilen som ska spelas.
      default: http://192.168.1.166:8123/local/imperial-alert.mp3
      selector:
        text:
    volume_level:
      name: Volymniv√•
      description: Volymniv√• f√∂r varningen.
      default: 0.5
      selector:
        number:
          min: 0
          max: 1
          step: 0.1
          unit_of_measurement: niv√•

trigger:
  - platform: time_pattern
    hours: /1

condition:
  - condition: state
    entity_id: !input sensor
    state: "on"

action:
  - repeat:
      while:
        - condition: state
          entity_id: !input sensor
          state: "on"
        - condition: template
          value_template: "{{ repeat.index <= !input repeat_count }}"
      sequence:
        - service: media_player.volume_set
          data:
            entity_id: !input media_player
            volume_level: !input volume_level
        - service: media_player.play_media
          data:
            entity_id: !input media_player
            media_content_id: !input media_content_id
            media_content_type: music
        - delay: "00:00:10"
        - service: tts.google_translate_say
          data:
            entity_id: !input media_player
            message: "Varning! Det √§r vatten uppt√§ckt vid {{ state_attr('!input sensor', 'friendly_name') }}"
            language: sv
        - service: notify.mobile_app
          data:
            target: !input notify_device
            title: "üö® VATTENLARM - {{ state_attr('!input sensor', 'friendly_name') }}"
            message: "Sensor har uppt√§ckt vattenl√§cka. Kontrollera omedelbart!"
            data:
              push:
                sound:
                  name: default
                  critical: 1
                  volume: 1
        - service: browser_mod.popup
          data:
            title: "üö® VATTENLARM"
            content:
              type: markdown
              content: >
                ## ‚õ∫ L√§ckage uppt√§ckt!
                **Plats:** `{{ states('!input sensor') }}`
            deviceID:
              - this
            style:
              width: 400px
              background: red
              color: white
              font-size: 20px
        - delay: "00:00:15"
        - service: browser_mod.close_popup
        - delay: "00:01:00"
  - condition: template
    value_template: "{{ states('!input sensor') == 'unavailable' }}"
  - service: notify.mobile_app
    data:
      target: !input notify_device
      title: "üö® SENSOR OTILLG√ÑNGLIG - {{ state_attr('!input sensor', 'friendly_name') }}"
      message: "Vattenl√§ckagesensorn vid {{ state_attr('!input sensor', 'friendly_name') }} kan inte n√•s f√∂r tillf√§llet. Kontrollera omedelbart!"
      data:
        push:
          sound:
            name: default
            critical: 1
            volume: 1

mode: single